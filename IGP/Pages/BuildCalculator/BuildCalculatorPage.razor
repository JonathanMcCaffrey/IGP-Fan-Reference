@layout PageLayout

@inject IStringLocalizer<Localizations> locale

@inject IKeyService keyService
@inject IImmortalSelectionService filterService
@inject IBuildOrderService buildOrderService
@inject IEconomyService economyService
@inject IToastService toastService
@inject ITimingService timingService

@page "/build-calculator"
@using Microsoft.Extensions.Localization

@implements IDisposable

<LayoutLargeContentComponent>
    <WebsiteTitleComponent>Build Calculator</WebsiteTitleComponent>

    <AlertComponent Type="@SeverityType.Warning">
        <Title>Work In Progress and Not Fully Tested</Title>
        <Message>
            Currently not considering training queue times. Lacking error toasts for invalid actions. Performance needs to be optimized. Calculations haven't been thoroughly compared against real gameplay. Added a 2 second delay to actions to account for casual micro (will probably tweak later).
        </Message>
    </AlertComponent>

    <ContentDividerComponent></ContentDividerComponent>


    <div class="calculatorGrid">

        <div style="grid-area: timing;" class="gridItem">
            <InfoTooltipComponent InfoText="@locale["Tooltip Timing Info"]">

                <TimingComponent></TimingComponent>
            </InfoTooltipComponent>
        </div>


        @if (true)
        {
            <div style="grid-area: chart;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip Chart Info"]">
                    <ChartComponent></ChartComponent>
                </InfoTooltipComponent>
            </div>
        }

        <div style="grid-area: filter;" class="gridItem">
            <InfoTooltipComponent InfoText="@locale["Tooltip Filter Info"]">
                <FilterComponent></FilterComponent>
            </InfoTooltipComponent>
        </div>

        @if (true)
        {
            <div style="grid-area: view;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip Entity Info"]">
                    <EntityClickViewComponent/>
                </InfoTooltipComponent>
            </div>
        }

        @if (true)
        {
            <div style="grid-area: bank;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip Bank Info"]">
                    <BankComponent></BankComponent>
                </InfoTooltipComponent>
            </div>
        }

        @if (true)
        {
            <div style="grid-area: army;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip Army Info"]">
                    <ArmyComponent></ArmyComponent>
                </InfoTooltipComponent>
            </div>
        }

        <div class="gridItem gridKeys">

            <InfoTooltipComponent InfoText="@locale["Tooltip Hotkey Info"]">

                <HotkeyViewerComponent Size="80"></HotkeyViewerComponent>
            </InfoTooltipComponent>
        </div>

        @if (true)
        {
            <div style="grid-area: highlights;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip Highlights Info"]">
                    <HighlightsComponent></HighlightsComponent>
                </InfoTooltipComponent>
            </div>
        }
        @if (true)
        {
            <div style="grid-area: buildorder;" class="gridItem">
                <InfoTooltipComponent InfoText="@locale["Tooltip BuildOrder Info"]">
                    <BuildOrderComponent></BuildOrderComponent>
                </InfoTooltipComponent>
            </div>
        }
    </div>

    <ContentDividerComponent></ContentDividerComponent>

    <PaperComponent>
        <FormLayoutComponent>
            <InfoBodyComponent>
                <InfoQuestionComponent>
                    What is this tool?
                </InfoQuestionComponent>
                <InfoAnswerComponent>
                    This is a calculator to determine build timings. Mostly so someone can quickly try out a few build orders to see if they somewhat make sense.
                </InfoAnswerComponent>
            </InfoBodyComponent>

            <InfoBodyComponent>
                <InfoQuestionComponent>
                    How does it work?
                </InfoQuestionComponent>
                <InfoAnswerComponent>
                    The tool calculates every second of game time. So if you attempt to build a <b>Legion Hall</b> as your first action, the tool will scan every second, until you get to one where the request can be made. In this case, that is interval 58.
                    <br/>
                    <br/>
                    If you then build 2 <b>Apostle of Bindings</b> a <b>Soul Foundry</b> and a 3 <b>Absolvers</b> you should see yourself roughly floating 500 alloy, with barely having any ether. Which means you could of gotten an <b>Acropolis</b> and a <b>Zentari</b> without hurting your build.
                    <br/>
                    <br/>
                    Try building <b>Apostle of Bindings</b> before the <b>Legion Hall</b> and see how that changes the timing of your 3 <b>Absolvers</b>. (Spoiler: <SpoilerTextComponent> your <b>Absolvers</b> will be built much faster, and you won't be floating so much alloy.</SpoilerTextComponent>)
                </InfoAnswerComponent>
            </InfoBodyComponent>

            <InfoBodyComponent>
                <InfoQuestionComponent>
                    What is CONTROl key for?
                </InfoQuestionComponent>
                <InfoAnswerComponent>
                    Economy and tech related upgrades for townhalls.
                </InfoAnswerComponent>
            </InfoBodyComponent>

            <InfoBodyComponent>
                <InfoQuestionComponent>
                    What is SHIFT key for?
                </InfoQuestionComponent>
                <InfoAnswerComponent>
                    Misc building related upgrades. (Omnivores)
                </InfoAnswerComponent>
            </InfoBodyComponent>

            <InfoBodyComponent>
                <InfoQuestionComponent>
                    What is 2 key for?
                </InfoQuestionComponent>
                <InfoAnswerComponent>
                    It will be for Pyre camps. Currently not implemented.
                </InfoAnswerComponent>
            </InfoBodyComponent>
        </FormLayoutComponent>
    </PaperComponent>
</LayoutLargeContentComponent>


<style>
    .calculatorGrid {
        display: grid;
        gap: 8px;
        max-width: 90vw;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        grid-template-rows: 600px 400px 450px;
        grid-template-areas:
            'timing view view view'
            'filter bank army army'
            'keys keys highlights buildorder'
            'chart chart chart chart';
    }

    .gridItem {
        border: 2px solid var(--paper-border);
        padding: 20px;
        background-color: var(--paper);
    }

    .gridKeys {
        grid-area: keys;
    }

    @@media only screen and (max-width: 1025px) {
        .gridKeys {
            background-color: #282A30;
        }

        .calculatorGrid {
            grid-template-columns: 1fr;
            grid-template-rows: auto;
            grid-template-areas:
                'timing'
                'view'
                'filter'
                'keys'
                'bank'
                'army'
                'highlights'
                'buildorder'
                'chart';
            padding-left: 2px;
            padding-right: 2px;
        }
        
        .gridItem {
            padding: 0px;
            border: 0px;
            width: 100%;
        }
    }
</style>


@code {
    protected override void OnInitialized()
    {
        economyService.Calculate(buildOrderService, timingService, 0);
        
        keyService.Subscribe(HandleClick);
    }
    
    void IDisposable.Dispose()
    {
        keyService.Unsubscribe(HandleClick);
    }

    
    private void HandleClick()
    {
        var hotkey = keyService.GetHotkey();

        if (hotkey == "")
        {
            return;
        }

        if (hotkey == "`")
        {
            buildOrderService.RemoveLast();
            economyService.Calculate(buildOrderService, timingService, buildOrderService.GetLastRequestInterval());
            return;
        }

        var hotkeyGroup = keyService.GetHotkeyGroup();
        var isHoldSpace = keyService.IsHoldingSpace();
        var faction = filterService.GetFactionType();
        var immortal = filterService.GetImmortalType();

        EntityModel? entity = EntityModel.GetFrom(hotkey!, hotkeyGroup, isHoldSpace, faction, immortal);

        if (entity == null)
        {
            return;
        }
        
        if (buildOrderService.Add(entity, economyService, toastService))
        {
            economyService.Calculate(buildOrderService, timingService, buildOrderService.GetLastRequestInterval());
        }
    }
}